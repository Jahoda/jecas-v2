name: Preview Comment

on:
  pull_request:
    paths:
      - 'content/posts/*.md'

jobs:
  comment:
    name: Add Preview Links
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Add preview comment
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          BRANCH="${{ github.head_ref }}"
          BASE_URL="https://jecas.cz/preview"
          OG_URL="https://jecas.cz/api/og/preview"

          # Get changed .md files from PR via GitHub API
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path | select(startswith("content/posts/") and endswith(".md"))')

          if [ -z "$CHANGED_FILES" ]; then
            echo "No article changes found"
            exit 0
          fi

          # Build comment body
          BODY="## Náhled článků"$'\n\n'
          for file in $CHANGED_FILES; do
            slug=$(basename "$file" .md)
            BODY+="### [${slug}](${BASE_URL}/${slug}?branch=${BRANCH})"$'\n'
            BODY+="![${slug}](${OG_URL}?slug=${slug}&branch=${BRANCH})"$'\n\n'
          done

          # Find existing comment
          COMMENT_ID=$(gh api "repos/$GH_REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("## Náhled článků"))) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            # Update existing comment
            gh api "repos/$GH_REPO/issues/comments/$COMMENT_ID" -X PATCH -f body="$BODY"
            echo "Updated comment $COMMENT_ID"
          else
            # Create new comment
            gh pr comment "$PR_NUMBER" --body "$BODY"
            echo "Created new comment"
          fi
