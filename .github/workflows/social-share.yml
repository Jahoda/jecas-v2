name: Share New Articles on Social Media

on:
  push:
    branches: [main, master]
    paths:
      - 'content/posts/*.md'

jobs:
  share-articles:
    name: Share New Articles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect new articles
        id: detect
        run: |
          echo "Detecting new articles..."
          node scripts/get-new-articles.js --json > new-articles.json
          cat new-articles.json

          # Check if there are any articles
          ARTICLE_COUNT=$(node -e "const data = require('./new-articles.json'); console.log(data.articles.length)")
          echo "article_count=$ARTICLE_COUNT" >> $GITHUB_OUTPUT

          if [ "$ARTICLE_COUNT" -gt "0" ]; then
            echo "has_articles=true" >> $GITHUB_OUTPUT
          else
            echo "has_articles=false" >> $GITHUB_OUTPUT
          fi

      - name: Post to X (Twitter)
        if: steps.detect.outputs.has_articles == 'true' && vars.ENABLE_X_POSTING == 'true'
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        run: |
          echo "Posting to X..."
          ARTICLES=$(cat new-articles.json)

          # Post each article
          node -e "
            const fs = require('fs');
            const { execSync } = require('child_process');
            const data = JSON.parse(fs.readFileSync('new-articles.json', 'utf-8'));

            for (const article of data.articles) {
              console.log('Posting article:', article.title);
              const articleJson = JSON.stringify(article);
              process.env.ARTICLE_JSON = articleJson;
              try {
                execSync('node scripts/post-to-x.js', {
                  stdio: 'inherit',
                  env: { ...process.env, ARTICLE_JSON: articleJson }
                });
              } catch (error) {
                console.error('Failed to post to X:', error.message);
              }
            }
          "

      - name: Post to Facebook
        if: steps.detect.outputs.has_articles == 'true' && vars.ENABLE_FACEBOOK_POSTING == 'true'
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
        run: |
          echo "Posting to Facebook..."

          # Post each article
          node -e "
            const fs = require('fs');
            const { execSync } = require('child_process');
            const data = JSON.parse(fs.readFileSync('new-articles.json', 'utf-8'));

            for (const article of data.articles) {
              console.log('Posting article:', article.title);
              const articleJson = JSON.stringify(article);
              try {
                execSync('node scripts/post-to-facebook.js', {
                  stdio: 'inherit',
                  env: { ...process.env, ARTICLE_JSON: articleJson }
                });
              } catch (error) {
                console.error('Failed to post to Facebook:', error.message);
              }
            }
          "

      - name: Summary
        if: steps.detect.outputs.has_articles == 'true'
        run: |
          echo "## Social Sharing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "New articles detected: ${{ steps.detect.outputs.article_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Articles shared:" >> $GITHUB_STEP_SUMMARY
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('new-articles.json', 'utf-8'));
            for (const article of data.articles) {
              console.log('- [' + article.title + '](' + article.url + ')');
            }
          " >> $GITHUB_STEP_SUMMARY
