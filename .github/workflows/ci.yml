name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup

      - name: Run Prettier check
        run: pnpm run lint

  check:
    name: Svelte Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup
        with:
          setup-env: 'true'

      - name: Run svelte-check
        run: pnpm run check

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, check]
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup
        with:
          setup-env: 'true'

      - name: Build
        run: pnpm run build

  check-links:
    name: Check Links in Changed Articles
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup

      - name: Get changed article files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'content/posts/*.md' | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Check links in changed articles
        if: steps.changed-files.outputs.files != ''
        run: node scripts/check-links.js ${{ steps.changed-files.outputs.files }}

  preview-comment:
    name: Add Preview Links
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}
    steps:
      - name: Add preview comment
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          BRANCH="${{ github.head_ref }}"
          BASE_URL="https://jecas.cz/preview"
          OG_URL="https://jecas.cz/api/og/preview"

          # Get changed .md files from PR via GitHub API
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path | select(startswith("content/posts/") and endswith(".md"))')

          if [ -z "$CHANGED_FILES" ]; then
            echo "No article changes found"
            exit 0
          fi

          # Build comment body
          BODY="## Náhled článků"$'\n\n'
          for file in $CHANGED_FILES; do
            slug=$(basename "$file" .md)
            BODY+="### [${slug}](${BASE_URL}/${slug}?branch=${BRANCH})"$'\n'
            BODY+="![${slug}](${OG_URL}?slug=${slug}&branch=${BRANCH})"$'\n\n'
          done

          # Find existing comment
          COMMENT_ID=$(gh api "repos/$GH_REPO/issues/$PR_NUMBER/comments" --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("## Náhled článků"))) | .id' | head -1)

          if [ -n "$COMMENT_ID" ]; then
            # Update existing comment
            gh api "repos/$GH_REPO/issues/comments/$COMMENT_ID" -X PATCH -f body="$BODY"
            echo "Updated comment $COMMENT_ID"
          else
            # Create new comment
            gh pr comment "$PR_NUMBER" --body "$BODY"
            echo "Created new comment"
          fi
